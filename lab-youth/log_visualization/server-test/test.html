
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Infobox:Multipull</title>
    <meta charset="utf-8">
    <style>html,body{height:100%;}body{padding:0;margin:0;background:#333;}h1{padding:0;margin:0;font-size:50%;color:white;}</style>
</head>
<script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=[API_KEY]' async defer></script>

<script>
const HEADERS = {
  "Content-Type": "application/json; charset=utf-8",
}
const URL = 'http://localhost:8000/'
var js = {}
const onAdd = (d) => {
  var js = {
    'date':d
  }
  // js[key] = value
  fetch(URL + 'get_pos', {
    method: 'POST',
    headers: HEADERS,
    body: JSON.stringify(js)
  }).then(res => res.json())
  .then(js => {
    GetMap([js['pos']],[js['count']]);//呼び出してピンに反映
  })
  .catch(err => console.error(err))
}

let infobox,map;
function GetMap(lati_longi,count) {
  if(!lati_longi){
    return 
  }
    //Map init
    map = new Microsoft.Maps.Map('#myMap', {
        center: new Microsoft.Maps.Location(47.6149, 122.1941),
        zoom: 2
    });
    let center = map.getCenter();

    //********************************************************************
    //infobox
    //********************************************************************
    infobox = new Microsoft.Maps.Infobox(center, {
        visible: false
    });
    infobox.setMap(map);//Add infobox to Map

    //********************************************************************
    //PushPin
    //********************************************************************
    //* Create test data *
    //* Create test data * Microsoft.Maps.TestDataGenerator.getLocations(Number of array, Display range)**

    lati_longi_cnt=lati_longi[0].length
    console.log("latilongi_length")
    console.log(lati_longi_cnt)
    console.log("cnt_length")
    console.log(count[0].length)
    console.log(count[0][19])
    for (let i=0; i<lati_longi_cnt;i++) {
        //pushpin: Set location

        var location = new Microsoft.Maps.Location(lati_longi[0][i][0],lati_longi[0][i][1]);
        let pin = new Microsoft.Maps.Pushpin(location);
        //PushuPin:Create display character for each
        pin.metadata = {
            title: 'Pin ' + i,
            description: '緯度経度[' + lati_longi[0][i] + ']' + '回数' + count[0][i]
        };

        Microsoft.Maps.Events.addHandler(pin, 'click', pushpinClicked);        
        map.entities.push(pin); // Add Pushpin to Map
    }
}

//Pushpin click event
function pushpinClicked(e) {
    if (e.target.metadata) {
        //Set information of clicked Pushpin
        infobox.setOptions({
            location: e.target.getLocation(),
            title: e.target.metadata.title,
            description: e.target.metadata.description,
            visible: true
        });
    }
}

</script>
<body>
  <button type="button" value="0" onclick="onAdd(0)">12/20~1/27</button>
  <button type="button" value="1" onclick="onAdd(1)">12/28~1/3</button> 
  <button type="button" value="2" onclick="onAdd(2)">1/4~1/10</button> 
  <button type="button" value="3" onclick="onAdd(3)">1/11~1/17</button>
  <button type="button" value="4" onclick="onAdd(4)">1/18~1/19</button> 
  <div id="myMap" style='width:100%;height:98%;'></div> 
 

</body>
</html>